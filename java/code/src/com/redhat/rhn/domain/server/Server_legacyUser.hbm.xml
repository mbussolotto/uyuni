<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE hibernate-mapping
PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
"http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">
<hibernate-mapping>
    <sql-query name="Server.findByIdsAndOrgId">
        <![CDATA[SELECT * FROM rhnServer WHERE org_id = :orgId AND id IN (:serverIds)]]>
        <return class="com.redhat.rhn.domain.server.Server" />
    </sql-query>
    
    <sql-query name="Server.findByIds">
        <![CDATA[SELECT * FROM rhnServer WHERE id IN (:serverIds)]]>
        <return class="com.redhat.rhn.domain.server.Server" />
    </sql-query>

    <sql-query name="Server.listRedHatSystems">
        <![CDATA[
            SELECT s.id 
            FROM rhnServer s
            INNER JOIN rhnServerArch sa ON s.server_arch_id = sa.id
            INNER JOIN rhnArchType at ON sa.arch_type_id = at.id
            WHERE s.id IN (:sids) AND at.label != 'sysv-solaris'
        ]]>
        <return class="com.redhat.rhn.domain.server.Server" />
    </sql-query>
    
    <sql-query name="Server.listOrgSystems">
        <![CDATA[SELECT * FROM rhnServer WHERE org_id = :orgId]]>
        <return class="com.redhat.rhn.domain.server.Server" />
    </sql-query>
    
    <sql-query name="Server.listConfigEnabledSystems">
        <![CDATA[
            SELECT s.*
            FROM rhnServer s
            INNER JOIN rhnServerGroupMembers sg ON s.id = sg.server_id
            INNER JOIN rhnServerGroup g ON sg.server_group_id = g.id
            INNER JOIN rhnServerGroupType gt ON g.group_type = gt.id
            INNER JOIN rhnServerGroupTypeFeature gtf ON gt.id = gtf.server_group_type_id
            INNER JOIN rhnFeature f ON gtf.feature_id = f.id
            INNER JOIN rhnClientCapability c ON s.id = c.server_id
            INNER JOIN rhnClientCapabilityName cap ON c.capability_name_id = cap.id
            WHERE gt.id IS NOT NULL 
              AND f.label = 'ftr_config' 
              AND cap.name LIKE 'configfiles%'
        ]]>
        <return class="com.redhat.rhn.domain.server.Server" />
    </sql-query>
    
    <sql-query name="Server.listMinionsByChannel">
        <![CDATA[
            SELECT ms.* 
            FROM suseMinionInfo ms
            INNER JOIN rhnServerChannel sc ON ms.server_id = sc.server_id
            WHERE sc.channel_id = :cid
        ]]>
    </sql-query>
    
    <sql-query name="Server.listFqdns">
        <![CDATA[
            SELECT fqdn.name
            FROM rhnServerFQDN fqdn
            WHERE fqdn.server_id = :sid
        ]]>
    </sql-query>
    
    <sql-query name="Server.findByFqdn">
        <![CDATA[
            SELECT s.* 
            FROM rhnServer s
            INNER JOIN rhnServerFQDN fqdn ON s.id = fqdn.server_id
            WHERE LOWER(fqdn.name) = LOWER(:name)
        ]]>
    </sql-query>
    
    <sql-query name="Server.listConfigDiffEnabledSystems">
        <![CDATA[
            SELECT s.*
            FROM rhnServer s
            INNER JOIN rhnServerGroupMembers sg ON s.id = sg.server_id
            INNER JOIN rhnServerGroup g ON sg.server_group_id = g.id
            INNER JOIN rhnServerGroupType gt ON g.group_type_id = gt.id
            INNER JOIN rhnServerGroupTypeFeature gtf ON gt.id = gtf.server_group_type_id
            INNER JOIN rhnFeature f ON gtf.feature_id = f.id
            INNER JOIN rhnClientCapability c ON s.id = c.server_id
            INNER JOIN rhnClientCapabilityName cap ON c.capability_name_id = cap.id
            WHERE gt.id IS NOT NULL 
              AND f.label = 'ftr_config' 
              AND cap.name = 'configfiles.diff'
            ORDER BY s.id ASC
        ]]>
    </sql-query>
    
    <sql-query name="Server.findNonZypperTradClientsIds">
        <![CDATA[
            SELECT s.id
            FROM rhnServer s
            WHERE s.id IN (:serverIds)
              AND NOT EXISTS (
                  SELECT 1 
                  FROM rhnServerPackage p
                  INNER JOIN rhnPackageName n ON p.name_id = n.id
                  WHERE p.server_id = s.id
                    AND n.name = 'zypper'
              )
              AND s.id NOT IN (SELECT server_id FROM suseMinionInfo)
        ]]>
    </sql-query>
    
    <sql-query name="Server.findZypperEvr">
        <![CDATA[
            SELECT p.evr
            FROM rhnServerPackage p
            INNER JOIN rhnPackageName n ON p.name_id = n.id
            WHERE p.server_id = :sid 
              AND n.name = 'zypper'
        ]]>
    </sql-query>

    <sql-query name="Server.findUnscheduledErrataByServerIds">
        <return-scalar column="serverId" type="long"/>
        <return-scalar column="errataId" type="long"/>
        <![CDATA[SELECT SNPC.server_id as serverId, E.id as errataId
                 FROM rhnErrata E, rhnServerNeededErrataCache SNPC
                 WHERE EXISTS (SELECT 1
                               FROM rhnUserServerPerms USP
                               WHERE USP.user_id = :user_id AND USP.server_id = SNPC.server_id)
                     AND SNPC.server_id in (:serverIds)
                     AND SNPC.errata_id = E.id
                     AND NOT EXISTS (SELECT 1
                                     FROM rhnActionErrataUpdate AEU, rhnServerAction SA, rhnActionStatus AST
                                     WHERE SA.server_id = SNPC.server_id
                                         AND SA.status = AST.id
                                         AND AST.name IN('Queued', 'Picked Up')
                                         AND AEU.action_id = SA.action_id
                                         AND AEU.errata_id = E.id )
                 ORDER BY E.id
        ]]>
    </sql-query>
    
    <sql-query name="Server.serverIdVirtualHostManagerId">
        <return-scalar column="server_id" type="long"/>
        <return-scalar column="vhmserver_id" type="long"/>
        <![CDATA[select server_id, vhmserver_id
            from suseServerVirtualHostManager
        ]]>
    </sql-query>

    <sql-query name="MinionServer.listSSHMinionsIdsAndContactMethods">
        <![CDATA[
            SELECT m.minion_id, c.label
            FROM rhnServer s
            INNER JOIN suseMinionInfo m ON s.id = m.server_id
            INNER JOIN suseServerContactMethod c ON s.contact_method_id = c.id
            WHERE c.label IN ('ssh-push', 'ssh-push-tunnel')
        ]]>
    </sql-query>

    <sql-query name="Server.findServerIdsByMinionIds">
    <![CDATA[ SELECT m.minion_id, s.id FROM rhnServer s
           JOIN suseMinionInfo m ON s.id = m.server_id
           WHERE m.minion_id IN (:minionIds);
    ]]>
    </sql-query>

    <sql-query name="Server.listMinionIdMappings">
        <return-scalar column="minion_id" type="string"/>
        <return-scalar column="server_id" type="long"/>
        <![CDATA[
         SELECT m.minion_id AS minion_id, s.id AS server_id
             FROM rhnServer s
                 JOIN suseMinionInfo m ON s.id = m.server_id
                 WHERE EXISTS (SELECT 1
                               FROM rhnUserServerPerms USP
                               WHERE USP.user_id = :user_id AND USP.server_id = s.id)
        ]]>
    </sql-query>
    
    <sql-query name="Server.listAllServersOsAndRelease">
        <![CDATA[
            SELECT DISTINCT s.os, s.release FROM rhnServer s
        ]]>
    </sql-query>

    <sql-query name="Server.findSimpleMinionsByServerIds">
        <![CDATA[
            SELECT m.server_id, m.minion_id
            FROM suseMinionInfo m
            WHERE m.server_id IN (:serverIds)
        ]]>
    </sql-query>
    
    <sql-query name="Server.lookupAdministrators">
        <![CDATA[select {wc.*}
                                                from WEB_CONTACT wc
                                                inner join rhnUserServerPerms usp on wc.id = usp.user_id
                                                inner join rhnServer S on S.id = usp.server_id
                  where
                                s.id = :sid
                                and s.org_id = :org_id
                                ]]>
                <return alias="wc" class="com.redhat.rhn.domain.user.legacy.UserImpl"/>
    </sql-query>

    <sql-query name="Server.listProxies">
        <![CDATA[select S.id
                                        from rhnServer S
                                        inner join rhnUserServerPerms USP on USP.server_id = S.id
                                        inner join rhnProxyInfo rpi on rpi.server_id = S.id
                                        where S.org_id = :orgId
                                        and USP.user_id = :userId
                                ]]>
    </sql-query>

     <sql-query name="Server.findInSet">
     <![CDATA[
         select S.*,
           case when ss.server_id is not null then 2
                when proxy.server_id is not null then 3
                when S.id is not null then 0 end as clazz_
             from rhnServer S
                     left outer join  suseMgrServerInfo SS on S.id = SS.server_id
                     left outer join  rhnProxyInfo proxy on S.id = proxy.server_id
                     inner join rhnSet ST on S.id = st.element
             where
                 ST.user_id = :userId
                 and ST.label = :label
                 and S.id not in (SELECT server_id FROM rhnProxyInfo)
           ]]>
        <return alias="S" class="com.redhat.rhn.domain.server.Server" />
    </sql-query>

    <sql-query name="Server.listErrataNamesForServers">
        <return-scalar column="errataId" type="long"/>
        <return-scalar column="serverId" type="long"/>
        <return-scalar column="advisoryName" type="string"/>
        <return-scalar column="updateTag" type="string"/>
        <return-scalar column="updateStack" type="boolean"/>
        <return-scalar column="includeSalt" type="boolean"/>
        <![CDATA[
          SELECT DISTINCT
            e.id AS errataId,
            sc.server_id AS serverId,
            e.advisory_name AS advisoryName,
            c.update_tag AS updateTag,
            CASE
              WHEN (SELECT COUNT(*) FROM rhnErrataKeyword k WHERE e.id = k.errata_id AND k.keyword = 'restart_suggested') > 0
            THEN 1
            ELSE 0
            END AS updateStack,
            CASE
              WHEN (SELECT COUNT(*) FROM rhnErrataPackage k WHERE e.id = k.errata_id AND k.package_id IN
                (SELECT id FROM rhnPackage p WHERE p.name_id IN
                  (SELECT id FROM rhnPackageName pn WHERE pn.name = 'salt' OR pn.name = 'venv-salt-minion'))) > 0
            THEN 1
            ELSE 0
            END AS includeSalt
          FROM rhnErrata e
              JOIN rhnChannelErrata ce ON e.id = ce.errata_id
              JOIN rhnChannel c ON ce.channel_id = c.id
              JOIN rhnServerChannel sc ON c.id = sc.channel_id
          WHERE e.id in (:errataIds) AND
              sc.server_id in (:serverIds)
        ]]>
    </sql-query>

    <sql-query name="Server.listNewestPkgsForServerErrata">
        <return-scalar column="serverId" type="long"/>
        <return-scalar column="packageName" type="string"/>
        <return-scalar column="packageArch" type="string"/>
        <return-scalar column="packageVersion" type="string"/>
        <![CDATA[
            WITH NewPackageForServerErrata as (
                 SELECT DISTINCT sc.server_id, pn.name, max(pevr.evr) evr, pa.label as package_arch
                   FROM rhnErrata e
                            INNER JOIN rhnErrataPackage ep ON e.id = ep.errata_id
                            INNER JOIN rhnPackage p ON ep.package_id = p.id
                            INNER JOIN rhnPackageEVR pevr ON p.evr_id = pevr.id
                            INNER JOIN rhnPackageName pn ON p.name_id = pn.id
                            INNER JOIN rhnPackageArch pa ON p.package_arch_id = pa.id

                            INNER JOIN rhnChannelErrata ce ON e.id = ce.errata_id
                            INNER JOIN rhnServerChannel sc ON (sc.channel_id = ce.channel_id AND sc.server_id in (:serverIds))
                            INNER JOIN rhnChannelPackage pc ON (pc.channel_id = sc.channel_id AND pc.package_id = p.id)

                            INNER JOIN rhnServerPackage sp ON (sp.server_id = sc.server_id AND p.name_id = sp.name_id AND p.package_arch_id = sp.package_arch_id)
                            INNER JOIN rhnPackageEVR spevr ON (sp.evr_id = spevr.id AND (pevr.evr).type = (spevr.evr).type AND pevr.evr > spevr.evr)
                          WHERE e.id in (:errataIds)
                       GROUP BY sc.server_id, pn.name, pa.label
            )
            SELECT pse.server_id AS serverId
                        , pse.name AS packageName
                        , pse.package_arch AS packageArch
                        , CASE WHEN (pse.evr).epoch IS NULL
                            THEN (pse.evr).version || '-' || (pse.evr).release
                            ELSE (pse.evr).epoch || ':' || (pse.evr).version || '-' || (pse.evr).release
                        END AS packageVersion
              FROM NewPackageForServerErrata pse
        ]]>
    </sql-query>

    <sql-query name="Server.findServerInSSMByChannel">
        <return-scalar column="serverId" type="long"/>
        <![CDATA[
            SELECT s.id AS serverId
            FROM rhnServer s
                JOIN rhnServerChannel sc ON s.id=sc.server_id AND sc.channel_id=:channel_id
                JOIN rhnSet rset ON rset.element = s.id AND rset.user_id = :user_id AND rset.label = 'system_list'
        ]]>
    </sql-query>
    
    <sql-query name="Server.setMaintenanceScheduleToSystems">
        <![CDATA[UPDATE rhnServer SET maintenance_schedule_id = :schedule WHERE id IN (:systemIds)]]>
    </sql-query>


    <sql-query name="Server.findServersPendingRebootAction">
        <![CDATA[SELECT DISTINCT sa.server_id FROM rhnServerAction sa
		JOIN rhnAction parentAction ON sa.action_id = parentAction.id
		WHERE sa.server_id IN (:systemIds)
  		AND parentAction.actionType = 'reboot.reboot'
  		AND sa.status IN (0, 1)]]>
    </sql-query>

    <sql-query name="Server.listAllServerIds">
        <![CDATA[SELECT id FROM rhnServer ORDER BY id]]>
    </sql-query>

</hibernate-mapping>
