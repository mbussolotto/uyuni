<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE hibernate-mapping
PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
"http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">

<hibernate-mapping>
        <import class="com.redhat.rhn.domain.server.GuestAndNonVirtHostView"/>

   <sql-query name="VirtualInstance.lookupGuestBySidAndOrg">
        <![CDATA[
            SELECT vi.*
            FROM RhnVirtualInstance vi
            JOIN rhnServer guest ON vi.virtual_system_id = guest.id
            JOIN rhnOrganization org ON guest.org_id = org.id  -- Assuming org is directly related to server
            WHERE guest.id = :sid AND org.id = :orgId
        ]]>
    </sql-query>

    <sql-query name="VirtualInstance.lookupGuestBySid">
        <![CDATA[
            SELECT vi.*
            FROM RhnVirtualInstance vi
            JOIN rhnServer guest ON vi.virtual_system_id = guest.id
            WHERE guest.id = :sid
        ]]>
    </sql-query>

    <sql-query name="VirtualInstance.lookupVirtualInstanceByUuid">
        <![CDATA[
            SELECT *  -- Or specify columns if needed
            FROM RhnVirtualInstance
            WHERE uuid = :uuid
        ]]>
    </sql-query>

    <sql-query name="VirtualInstance.lookupHostVirtInstanceByHostId">
        <![CDATA[
            SELECT vi.*
            FROM RhnVirtualInstance vi
            JOIN rhnServer host ON vi.host_system_id = host.id
            WHERE vi.uuid IS NULL AND host.id = :hostId
        ]]>
    </sql-query>

    <sql-query name="VirtualInstance.lookupHostVirtInstanceByHostIdAndUuid">
        <![CDATA[
            SELECT vi.*
            FROM RhnVirtualInstance vi
            JOIN rhnServer host ON vi.host_system_id = host.id
            WHERE vi.uuid = :uuid AND host.id = :hostId
        ]]>
    </sql-query>

    <sql-query name="VirtualInstance.isOutdatedVirtualInstance">
        <![CDATA[
            SELECT vi1.*
            FROM RhnVirtualInstance vi1
            WHERE vi1.id = :guestId  -- You'll need to provide the guest's ID
              AND vi1.modified < (
                  SELECT MAX(vi2.modified)
                  FROM RhnVirtualInstance vi2
                  WHERE vi2.uuid = vi1.uuid
              )
        ]]>
    </sql-query>

    <sql-query name="VirtualInstance.findGuestsWithNonVirtHostByOrg">
        <![CDATA[
            SELECT
                guest.id AS guest_id,
                guest.org_id AS guest_org_id,
                guest.name AS guest_name,
                host.org_id AS host_org_id,
                host.id AS host_id,
                host.name AS host_name
            FROM
                RhnVirtualInstance vi
                INNER JOIN rhnServer guest ON vi.virtual_system_id = guest.id
                INNER JOIN rhnServer host ON vi.host_system_id = host.id
            WHERE
                guest.org_id = :org_id AND
                (host.org_id != :org_id OR
                NOT EXISTS (
                    SELECT 1 
                    FROM rhnServerGroupMembers sgm
                        INNER JOIN rhnServerGroup sg ON sgm.server_group_id = sg.id
                        INNER JOIN rhnServerGroupType sgt ON sg.group_type = sgt.id
                    WHERE
                        sgt.label = 'virtualization_host' AND
                        sgm.server_id = host.id
                ))
        ]]>
    </sql-query>

    <sql-query name="VirtualInstance.findGuestsWithoutAHostByOrg">
        <![CDATA[
        SELECT guest.id, guest.org_id, guest.name
        FROM RhnVirtualInstance vi
        JOIN rhnServer guest ON vi.virtual_system_id = guest.id
        WHERE vi.host_system_id IS NULL AND guest.org_id = :org_id
        ]]>
    </sql-query>

</hibernate-mapping>
